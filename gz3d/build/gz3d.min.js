var GZ3D=GZ3D||{REVISION:"1"},guiEvents=new EventEmitter2({verbose:!0});$(function(){$("#box").button({text:!1,icons:{primary:"toolbar-box"}}).click(function(){guiEvents.emit("entity_create","box")}),$("#sphere").button({text:!1,icons:{primary:"toolbar-sphere"}}).click(function(){guiEvents.emit("entity_create","sphere")}),$("#cylinder").button({text:!1,icons:{primary:"toolbar-cylinder"}}).click(function(){guiEvents.emit("entity_create","cylinder")}),$("#play").button({text:!1,icons:{primary:"ui-icon-play"}}).click(function(){"Play"===$(this).text()?guiEvents.emit("pause",!1):guiEvents.emit("pause",!0)})}),$(function(){$("#menu").menu(),$("#reset-model").click(function(){guiEvents.emit("model_reset")}),$("#reset-world").click(function(){guiEvents.emit("world_reset")})}),GZ3D.Gui=function(a){this.scene=a,this.domElement=a.getDomElement(),this.init(),this.emitter=new EventEmitter2({verbose:!0})},GZ3D.Gui.prototype.init=function(){this.spawnModel=new GZ3D.SpawnModel(this.scene,this.scene.getDomElement());var a=this;guiEvents.on("entity_create",function(b){a.spawnModel.start(b,function(c){a.emitter.emit("entityCreated",c,b)})}),guiEvents.on("world_reset",function(){a.emitter.emit("reset","world")}),guiEvents.on("model_reset",function(){a.emitter.emit("reset","model")}),guiEvents.on("pause",function(b){a.emitter.emit("pause",b)})},GZ3D.Gui.prototype.setPaused=function(a){var b;b=a?{label:"Play",icons:{primary:"ui-icon-play"}}:{label:"Pause",icons:{primary:"ui-icon-pause"}},$("#play").button("option",b)},GZ3D.GZIface=function(a,b){this.scene=a,this.gui=b,this.init()},GZ3D.GZIface.prototype.init=function(){this.material=[],this.webSocket=new ROSLIB.Ros({url:"ws://"+location.hostname+":7681"}),this.heartbeatTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/heartbeat",messageType:"heartbeat"});var a=this,b=function(){var b={alive:1};a.heartbeatTopic.publish(b)};setInterval(b,5e3);var c=new ROSLIB.Topic({ros:this.webSocket,name:"~/material",messageType:"material"}),d=function(a){this.material=a};c.subscribe(d.bind(this)),this.sceneTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/scene",messageType:"scene"});var e=function(a){a.grid===!0&&this.scene.createGrid();for(var b=0;b<a.light.length;++b){var c=a.light[b],d=this.createLightFromMsg(c);this.scene.add(d)}for(var e=0;e<a.model.length;++e){var f=a.model[e],g=this.createModelFromMsg(f);this.scene.add(g)}this.sceneTopic.unsubscribe()};this.sceneTopic.subscribe(e.bind(this));var f=new ROSLIB.Topic({ros:this.webSocket,name:"~/pose/info",messageType:"pose"}),g=function(a){var b=this.scene.getByName(a.name);b&&this.scene.updatePose(b,a.position,a.orientation)};f.subscribe(g.bind(this));var h=new ROSLIB.Topic({ros:this.webSocket,name:"~/request",messageType:"request"}),i=function(a){if("entity_delete"===a.request){var b=this.scene.getByName(a.data);b&&this.scene.remove(b)}};h.subscribe(i.bind(this));var j=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/info",messageType:"model"}),k=function(a){var b=this.createModelFromMsg(a);this.scene.add(b)};j.subscribe(k.bind(this));var l=new ROSLIB.Topic({ros:this.webSocket,name:"~/world_stats",messageType:"world_stats"}),m=function(a){this.updateStatsGuiFromMsg(a)};l.subscribe(m.bind(this));var n=new ROSLIB.Topic({ros:this.webSocket,name:"~/light",messageType:"light"}),o=function(a){var b=this.createLightFromMsg(a);this.scene.add(b)};n.subscribe(o.bind(this)),this.modelModifyTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/modify",messageType:"model"});var p=function(b){var c=b.matrixWorld,d=new THREE.Vector3,e=new THREE.Quaternion,f=new THREE.Vector3;c.decompose(d,e,f);var g={name:b.name,id:b.userData,position:{x:d.x,y:d.y,z:d.z},orientation:{w:e.w,x:e.x,y:e.y,z:e.z}};a.modelModifyTopic.publish(g)};this.scene.emitter.on("poseChanged",p),this.factoryTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/factory",messageType:"factory"});var q=function(b,c){var d=b.matrixWorld,e=new THREE.Vector3,f=new THREE.Quaternion,g=new THREE.Vector3;d.decompose(e,f,g);var h={name:b.name,type:c,position:{x:e.x,y:e.y,z:e.z},orientation:{w:f.w,x:f.x,y:f.y,z:f.z}};a.factoryTopic.publish(h)};this.worldControlTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/world_control",messageType:"world_control"});var r=function(b,c){var d={};null!==b&&(d.pause=b),c&&(d.reset=c),a.worldControlTopic.publish(d)};this.scene.emitter.on("poseChanged",p),this.gui.emitter.on("entityCreated",q),this.gui.emitter.on("reset",function(a){r(null,a)}),this.gui.emitter.on("pause",function(a){r(a,null)})},GZ3D.GZIface.prototype.updateStatsGuiFromMsg=function(a){this.gui.setPaused(a.paused)},GZ3D.GZIface.prototype.createModelFromMsg=function(a){var b=new THREE.Object3D;b.name=a.name,b.userData=a.id,a.pose&&this.scene.setPose(b,a.pose.position,a.pose.orientation);for(var c=0;c<a.link.length;++c){var d=a.link[c],e=new THREE.Object3D;e.name=d.name,e.userData=d.id,d.pose&&this.scene.setPose(e,d.pose.position,d.pose.orientation),b.add(e);for(var f=0;f<d.visual.length;++f){var g=d.visual[f];if(g.geometry){var h=g.geometry,i=new THREE.Object3D;i.name=g.name,g.pose&&this.scene.setPose(i,g.pose.position,g.pose.orientation),this.createGeom(h,g.material,i),i.children.length>0&&(i.children[0].castShadow=g.cast_shadows||!0,i.children[0].receiveShadow=!0),e.add(i)}}}return b},GZ3D.GZIface.prototype.createLightFromMsg=function(a){var b,c=new THREE.Color;if(c.r=a.diffuse.r,c.g=a.diffuse.g,c.b=a.diffuse.b,1===a.type&&(b=new THREE.AmbientLight(c.getHex()),b.distance=a.range,this.scene.setPose(b,a.pose.position,a.pose.orientation)),2===a.type)b=new THREE.SpotLight(c.getHex()),b.distance=a.range,this.scene.setPose(b,a.pose.position,a.pose.orientation);else if(3===a.type){b=new THREE.DirectionalLight(c.getHex());var d=new THREE.Vector3(a.direction.x,a.direction.y,a.direction.z),e=d,f=d.negate();f.normalize();var g=10;a.pose.position.x+=g*f.x,a.pose.position.y+=g*f.y,a.pose.position.z+=g*f.z,e.x-=a.pose.position.x,e.y-=a.pose.position.y,e.z-=a.pose.position.z,b.target.position=e,b.shadowCameraNear=1,b.shadowCameraFar=50,b.shadowMapWidth=2048,b.shadowMapHeight=2048,b.shadowCameraVisible=!1,b.shadowCameraBottom=-100,b.shadowCameraLeft=-100,b.shadowCameraRight=100,b.shadowCameraTop=100,this.scene.setPose(b,a.pose.position,a.pose.orientation)}return b.intensity=a.attenuation_constant,b.castShadow=a.cast_shadows,b.shadowDarkness=.5,b.name=a.name,b},GZ3D.GZIface.prototype.createGeom=function(a,b,c){var d,e,f,g,h,i="assets";if(b){var j=b.script;if(j&&j.uri.length>0&&j.name&&(h=this.material[j.name])){var k=h.texture;if(k){for(var l=0;l<j.uri.length;++l){var m=j.uri[l].substring(0,j.uri[l].indexOf("://"));if("model"===m){if(j.uri[l].indexOf("textures")>0){g=j.uri[l].substring(j.uri[l].indexOf("://")+3);break}}else if("file"===m&&j.uri[l].indexOf("materials")>0){g=j.uri[l].substring(j.uri[l].indexOf("://")+3,j.uri[l].indexOf("materials")+9)+"/textures";break}}g&&(e=i+"/"+g+"/"+k)}}if(b.normal_map){var n;if(n=b.normal_map.indexOf("://")>0?b.normal_map.substring(b.normal_map.indexOf("://")+3,b.normal_map.lastIndexOf("/")):g){var o=b.normal_map.lastIndexOf("/")+1;0>o&&(o=0);var p=b.normal_map.substr(o,b.normal_map.lastIndexOf(".")-o);f=i+"/"+n+"/"+p+".png"}}}if(a.box)d=this.scene.createBox(a.box.size.x,a.box.size.y,a.box.size.z);else if(a.cylinder)d=this.scene.createCylinder(a.cylinder.radius,a.cylinder.length);else if(a.sphere)d=this.scene.createSphere(a.sphere.radius);else if(a.plane)d=this.scene.createPlane(a.plane.normal.x,a.plane.normal.y,a.plane.normal.z,a.plane.size.x,a.plane.size.y);else if(a.mesh){for(var q=c;q.parent;)q=q.parent;var r=a.mesh.filename,s=a.mesh.submesh,t=a.mesh.center_submesh;console.log(a.mesh.filename+" "+s);var u=r.substring(0,r.indexOf("://"));if("file"===u||"model"===u){var v=r.substring(r.indexOf("://")+3);a.mesh.scale&&(c.scale.x=a.mesh.scale.x,c.scale.y=a.mesh.scale.y,c.scale.z=a.mesh.scale.z),this.scene.loadMesh(i+"/"+v,s,t,e,f,c)}}if(d){if(h){d.material=new THREE.MeshPhongMaterial;var w=h.ambient;w&&d.material.ambient.setRGB(w[0],w[1],w[2]);var x=h.diffuse;x&&d.material.color.setRGB(x[0],x[1],x[2]);var y=h.specular;y&&d.material.specular.setRGB(y[0],y[1],y[2]),e&&(d.material.map=THREE.ImageUtils.loadTexture(e)),f&&(d.material.normalMap=THREE.ImageUtils.loadTexture(f))}d.updateMatrix(),c.add(d)}},GZ3D.Scene=function(){this.init()},GZ3D.Scene.prototype.init=function(){this.scene=new THREE.Scene,this.scene.name="scene",this.meshes={},this.selectedEntity=null,this.mouseEntity=null,this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setClearColor(13421772,1),this.renderer.setSize(window.innerWidth,window.innerHeight);var a=new THREE.AmbientLight(2236962);this.scene.add(a),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.x=0,this.camera.position.y=-5,this.camera.position.z=5,this.camera.up=new THREE.Vector3(0,0,1),this.camera.lookAt(0,0,0);var b=this;this.getDomElement().addEventListener("mousedown",function(a){b.onMouseDown(a)},!1),this.getDomElement().addEventListener("mouseup",function(a){b.onMouseUp(a)},!1),this.modelManipulator=new THREE.TransformControls(this.camera,this.getDomElement()),this.controls=new THREE.OrbitControls(this.camera),this.emitter=new EventEmitter2({verbose:!0})},GZ3D.Scene.prototype.onMouseDown=function(a){if(a.preventDefault(),this.controls.enabled=!0,0===a.button){var b=new THREE.Projector,c=new THREE.Vector3(2*(a.clientX/window.innerWidth)-1,2*-(a.clientY/window.innerHeight)+1,.5);b.unprojectVector(c,this.camera);var d=new THREE.Raycaster(this.camera.position,c.sub(this.camera.position).normalize()),e=[];this.scene.getDescendants(e);var f=d.intersectObjects(e);if(f.length>0){for(var g,h=0;h<f.length;++h){if(g=f[h].object,!this.modelManipulator.hovered&&("grid"===f[h].object.name||"plane"===f[h].object.name))return this.killCameraControl=!1,void 0;for(;g.parent!==this.scene;)g=g.parent;if(this.modelManipulator.hovered){if(g===this.modelManipulator.gizmo)break}else if(""!==g.name)break}g?(console.log("found model "+g.name+" "+f.length),""!==g.name?(console.log("attached "+g.name),this.modelManipulator.attach(g),this.selectedEntity=g,this.mouseEntity=this.selectedEntity,this.scene.add(this.modelManipulator.gizmo),this.killCameraControl=!0):this.modelManipulator.hovered?(console.log("hovered "+this.modelManipulator.object.name),this.modelManipulator.update(),this.modelManipulator.object.updateMatrixWorld(),this.mouseEntity=this.selectedEntity,this.killCameraControl=!0):this.killCameraControl=!1):(console.log("detached"),this.modelManipulator.detach(),this.scene.remove(this.modelManipulator.gizmo),this.killCameraControl=!1,this.selectedEntity=null)}}},GZ3D.Scene.prototype.onMouseUp=function(a){a.preventDefault(),this.controls.enabled=!0,this.modelManipulator.hovered&&this.selectedEntity?this.emitter.emit("poseChanged",this.modelManipulator.object):this.killCameraControl&&(this.killCameraControl=!1),this.mouseEntity=null},GZ3D.Scene.prototype.getDomElement=function(){return this.renderer.domElement},GZ3D.Scene.prototype.render=function(){this.killCameraControl?this.controls.enabled=!1:(this.controls.enabled=!0,this.controls.update()),this.modelManipulator.update(),this.renderer.render(this.scene,this.camera)},GZ3D.Scene.prototype.setWindowSize=function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.render()},GZ3D.Scene.prototype.add=function(a){this.scene.add(a)},GZ3D.Scene.prototype.remove=function(a){this.scene.remove(a)},GZ3D.Scene.prototype.getByName=function(a){return this.scene.getObjectByName(a,!0)},GZ3D.Scene.prototype.updatePose=function(a,b,c){this.modelManipulator&&this.modelManipulator.object&&this.modelManipulator.hovered&&this.mouseEntity||this.setPose(a,b,c)},GZ3D.Scene.prototype.setPose=function(a,b,c){a.position.x=b.x,a.position.y=b.y,a.position.z=b.z,a.quaternion.w=c.w,a.quaternion.x=c.x,a.quaternion.y=c.y,a.quaternion.z=c.z},GZ3D.Scene.prototype.createGrid=function(){var a=new THREE.GridHelper(10,1);a.name="grid",a.position.z=.05,a.rotation.x=.5*Math.PI,a.castShadow=!1,this.scene.add(a)},GZ3D.Scene.prototype.createPlane=function(a,b,c,d,e){var f=new THREE.PlaneGeometry(d,e,1,1),g=new THREE.MeshPhongMaterial({color:12303291,shading:THREE.SmoothShading}),h=new THREE.Mesh(f,g),i=new THREE.Vector3(a,b,c),j=i.crossVectors(i,h.up);return h.rotation=i.applyAxisAngle(j,-i.angleTo(h.up)),h.name="plane",h.receiveShadow=!0,h},GZ3D.Scene.prototype.createSphere=function(a){var b=new THREE.SphereGeometry(a,32,32),c=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),d=new THREE.Mesh(b,c);return d},GZ3D.Scene.prototype.createCylinder=function(a,b){var c=new THREE.CylinderGeometry(a,a,b,32,1,!1),d=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),e=new THREE.Mesh(c,d);return e.rotation.x=.5*Math.PI,e},GZ3D.Scene.prototype.createBox=function(a,b,c){var d=new THREE.CubeGeometry(a,b,c,1,1,1);d.dynamic=!0;for(var e=[1,4,5],f=[0],g=0;g<e.length;++g){for(var h=e[g],i=d.faceVertexUvs[0][h].length,j=d.faceVertexUvs[0][h][i-1],k=i-2;k>=0;--k){var l=d.faceVertexUvs[0][h][k];d.faceVertexUvs[0][h][k]=j,j=l}d.faceVertexUvs[0][h][i-1]=j}for(var m=0;m<f.length;++m){for(var n=f[m],o=d.faceVertexUvs[0][n][0],p=1;p<d.faceVertexUvs[0][n].length;++p){var q=d.faceVertexUvs[0][n][p];d.faceVertexUvs[0][n][p]=o,o=q}d.faceVertexUvs[0][n][0]=o}d.uvsNeedUpdate=!0;var r=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),s=new THREE.Mesh(d,r);return s.castShadow=!0,s},GZ3D.Scene.prototype.loadMesh=function(a,b,c,d,e,f){var g=a.substring(0,a.lastIndexOf("/")),h=a.substring(a.lastIndexOf("/")+1);if(".dae"===h.substr(-4).toLowerCase())return this.loadCollada(a,b,c,d,e,f);if(".urdf"===h.substr(-5).toLowerCase()){var i=new ROSLIB.UrdfModel({string:a}),j=i.links;for(var k in j){var l=j[k];if(l.visual&&l.visual.geometry&&l.visual.geometry.type===ROSLIB.URDF_MESH){"/"+l.name;var m=l.visual.geometry.filename,n=m.substr(-4).toLowerCase(),o=m.substring(m.indexOf("://")+3);if(".dae"===n){var p=this.loadCollada(g+"/"+o,f);l.visual.geometry.scale&&(p.scale=new THREE.Vector3(l.visual.geometry.scale.x,l.visual.geometry.scale.y,l.visual.geometry.scale.z))}}}}},GZ3D.Scene.prototype.loadCollada=function(a,b,c,d,e,f){var g;this.meshes[a]&&(g=this.meshes[a]);var h=new THREE.ColladaLoader,i=a,j=b,k=c;h.load(a,function(a){g=a.scene,g.updateMatrix(),this.scene.meshes[i]=g;var b,c=[];g.getDescendants(c);for(var h=0;h<c.length;++h)if(c[h]instanceof THREE.Mesh){if(j||b||(b=c[h]),j)if(c[h].geometry.name===j){if(k){var l=c[h].geometry.vertices,m=new THREE.Vector3,n=new THREE.Vector3;m.x=l[0].x,m.y=l[0].y,m.z=l[0].z,n.x=m.x,n.y=m.y,n.z=m.z;for(var o=1;o<l.length;++o)m.x=Math.min(m.x,l[o].x),m.y=Math.min(m.y,l[o].y),m.z=Math.min(m.z,l[o].z),n.x=Math.max(n.x,l[o].x),n.y=Math.max(n.y,l[o].y),n.z=Math.max(n.z,l[o].z);var p=new THREE.Vector3;p.x=-(m.x+.5*(n.x-m.x)),p.y=-(m.y+.5*(n.y-m.y)),p.z=-(m.z+.5*(n.z-m.z)),c[h].parent.position.x=0,c[h].parent.position.y=0,c[h].parent.position.z=0}b=c[h]}else c[h].parent.remove(c[h])}else c[h]instanceof THREE.Light&&c[h].parent.remove(c[h]);if(d||e){var q=new THREE.MeshPhongMaterial;d&&(q.map=THREE.ImageUtils.loadTexture(d)),e&&(q.normalMap=THREE.ImageUtils.loadTexture(e)),b.material=q}f.add(g)})},GZ3D.SpawnModel=function(a,b){this.scene=a,this.domElement=void 0!==b?b:document,this.init(),this.obj=void 0,this.callback=void 0,this.counter=0},GZ3D.SpawnModel.prototype.init=function(){this.plane=new THREE.Plane(new THREE.Vector3(0,0,1),0),this.projector=new THREE.Projector,this.ray=new THREE.Ray,this.obj=null,this.active=!1},GZ3D.SpawnModel.prototype.start=function(a,b){this.active&&this.finish(),this.callback=b,this.obj=new THREE.Object3D;var c;"box"===a?(c=this.scene.createBox(1,1,1),this.obj.name="unit_box_gzweb_"+this.counter++):"sphere"===a?(c=this.scene.createSphere(.5),this.obj.name="unit_sphere_gzweb_"+this.counter++):"cylinder"===a&&(c=this.scene.createCylinder(.5,1),this.obj.name="unit_cylinder_gzweb_"+this.counter++),this.obj.add(c),this.obj.position.z+=.5,this.scene.add(this.obj);var d=this;this.domElement.addEventListener("mousedown",function(a){d.onMouseUp(a)},!1),this.domElement.addEventListener("mousemove",function(a){d.onMouseMove(a)},!1),document.addEventListener("keydown",function(a){d.onKeyDown(a)},!1),this.active=!0},GZ3D.SpawnModel.prototype.finish=function(){this.active=!1;var a=this;this.domElement.removeEventListener("mousedown",function(b){a.onMouseUp(b)},!1),this.domElement.removeEventListener("mousemove",function(b){a.onMouseMove(b)},!1),document.removeEventListener("keydown",function(b){a.onKeyDown(b)},!1),this.scene.remove(this.obj),this.obj=void 0},GZ3D.SpawnModel.prototype.onMouseDown=function(a){a.preventDefault()},GZ3D.SpawnModel.prototype.onMouseMove=function(a){if(this.active){a.preventDefault();var b=new THREE.Vector3(2*(a.clientX/window.innerWidth)-1,2*-(a.clientY/window.innerHeight)+1,.5);this.projector.unprojectVector(b,this.scene.camera),this.ray.set(this.scene.camera.position,b.sub(this.scene.camera.position).normalize());var c=this.ray.intersectPlane(this.plane);c.z=this.obj.position.z,this.scene.setPose(this.obj,c,new THREE.Quaternion)}},GZ3D.SpawnModel.prototype.onMouseUp=function(){this.active&&(this.callback(this.obj),this.finish())},GZ3D.SpawnModel.prototype.onKeyDown=function(a){console.log(a.keyCode),27===a.keyCode&&this.finish()};