var GZ3D=GZ3D||{REVISION:"1"},GAZEBO_MODEL_DATABASE_URI="http://gazebosim.org/models";GZ3D.GZIface=function(a){this.scene=a,this.init()},GZ3D.GZIface.prototype.init=function(){this.webSocket=new ROSLIB.Ros({url:"ws://localhost:7681"});var a=new ROSLIB.Topic({ros:this.webSocket,name:"~/scene",messageType:"scene"}),b=function(a){a.grid===!0&&this.scene.createGrid();for(var b=0;b<a.light.length;++b){var c=a.light[b],d=this.createLightFromMsg(c);this.scene.add(d)}for(var e=0;e<a.model.length;++e){var f=a.model[e],g=this.createModelFromMsg(f);this.scene.add(g)}};a.subscribe(b.bind(this));var c=new ROSLIB.Topic({ros:this.webSocket,name:"~/pose/info",messageType:"pose"}),d=function(a){var b=this.scene.getByName(a.name);b&&(b.position=a.position,b.quaternion=a.orientation)};c.subscribe(d.bind(this));var e=new ROSLIB.Topic({ros:this.webSocket,name:"~/request",messageType:"request"}),f=function(a){if("entity_delete"===a.request){var b=this.scene.getByName(a.data);b&&this.scene.remove(b)}};e.subscribe(f.bind(this));var g=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/info",messageType:"model"}),h=function(a){var b=this.createModelFromMsg(a);this.scene.add(b)};g.subscribe(h.bind(this));var i=new ROSLIB.Topic({ros:this.webSocket,name:"~/light",messageType:"light"}),j=function(a){var b=this.createLightFromMsg(a);this.scene.add(b)};i.subscribe(j.bind(this))},GZ3D.GZIface.prototype.createModelFromMsg=function(a){var b=new THREE.Object3D;b.name=a.name,a.pose&&(b.position=a.pose.position,b.quaternion=a.pose.orientation);for(var c=0;c<a.link.length;++c){var d=a.link[c],e=new THREE.Object3D;e.name=d.name,d.pose&&(e.position=d.pose.position,e.quaternion=d.pose.orientation),b.add(e);for(var f=0;f<d.visual.length;++f){var g=d.visual[f];if(g.geometry){var h=g.geometry,i=new THREE.Object3D;i.name=g.name,g.pose&&(i.position=g.pose.position,i.quaternion=g.pose.orientation),this.createGeom(h,g.material,i),e.add(i)}}}return b},GZ3D.GZIface.prototype.createLightFromMsg=function(a){var b,c="rgb("+255*a.diffuse.r+","+255*a.diffuse.g+","+255*a.diffuse.b+")";return 1===a.type&&(b=new THREE.PointLight(c),b.distance=a.range),2===a.type?(b=new THREE.SpotLight(c),b.distance=a.range):3===a.type&&(b=new THREE.DirectionalLight(c)),b.intensity=a.attenuation_constant,b.castShadow=a.cast_shadows,a.pose&&(b.position=a.pose.position,b.quaternion=a.pose.orientation),b.name=a.name,b},GZ3D.GZIface.prototype.createGeom=function(a,b,c){var d;if(a.box)d=this.scene.createBox(a.box.size.x,a.box.size.y,a.box.size.z);else if(a.cylinder)d=this.scene.createCylinder(a.cylinder.radius,a.cylinder.length);else if(a.sphere)d=this.scene.createSphere(a.sphere.radius);else if(a.mesh){for(var e=c;e.parent;)e=e.parent;var f,g=GAZEBO_MODEL_DATABASE_URI+"/manifest.xml",h=new XMLHttpRequest;h.open("GET",g,!1),h.onreadystatechange=function(){4===h.readyState&&(200===h.status||0===h.status)&&(f=h.responseXML)},h.send();var i,j,k=!1,l=f.getElementsByTagName("models")[0];for(j=0;j<l.getElementsByTagName("uri").length;++j){var m=l.getElementsByTagName("uri")[j],n=m.substring(m.indexOf("://")+3);n===e&&(k=!0)}if(k){var o=a.mesh.uri,p=o.substring(0,o.indexOf("://"));("file"===p||"model"===p)&&(d=this.scene.loadURI(i+"/"+o.substring(o.indexOf("://")+3)))}}d&&(d.updateMatrix(),c.add(d))},GZ3D.Scene=function(){this.init()},GZ3D.Scene.prototype.init=function(){this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setClearColor(13421772,1),this.renderer.setSize(window.innerWidth,window.innerHeight);var a=new THREE.AmbientLight(2236962);this.scene.add(a),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x=0,this.camera.position.y=-5,this.camera.position.z=5,this.camera.up=new THREE.Vector3(0,0,1),this.camera.lookAt(0,0,0),this.controls=new THREE.TrackballControls(this.camera),this.controls.rotateSpeed=1,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68],this.controls.addEventListener("change",this.render.call(this)),this.iface=new GZ3D.GZIface(this)},GZ3D.Scene.prototype.getDomElement=function(){return this.renderer.domElement},GZ3D.Scene.prototype.render=function(){this.renderer.render(this.scene,this.camera),this.controls.update()},GZ3D.Scene.prototype.setWindowSize=function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.controls.handleResize(),this.render()},GZ3D.Scene.prototype.add=function(a){this.scene.add(a)},GZ3D.Scene.prototype.remove=function(a){this.scene.remove(a)},GZ3D.Scene.prototype.getByName=function(a){return this.scene.getObjectByName(a)},GZ3D.Scene.prototype.createGrid=function(){var a=new THREE.GridHelper(10,1);a.rotation.x=.5*Math.PI,this.scene.add(a)},GZ3D.Scene.prototype.createSphere=function(a){var b=new THREE.SphereGeometry(a,32,32),c=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),d=new THREE.Mesh(b,c);return d},GZ3D.Scene.prototype.createCylinder=function(a,b){var c=new THREE.CylinderGeometry(a,a,b,32,1,!1),d=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),e=new THREE.Mesh(c,d);return e.rotation.x=.5*Math.PI,e},GZ3D.Scene.prototype.createBox=function(a,b,c){var d=new THREE.CubeGeometry(a,b,c,1,1,1),e=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),f=new THREE.Mesh(d,e);return f},GZ3D.Scene.prototype.loadURI=function(a){var b=a.substring(0,a.lastIndexOf("/")),c=a.substring(a.lastIndexOf("/")+1);if(".dae"===c.substr(-4).toLowerCase())return this.loadCollada(a);if(".urdf"===c.substr(-5).toLowerCase()){var d=new ROSLIB.UrdfModel({string:a}),e=d.links;for(var f in e){var g=e[f];if(g.visual&&g.visual.geometry&&g.visual.geometry.type===ROSLIB.URDF_MESH){"/"+g.name;var h=g.visual.geometry.filename,i=h.substr(-4).toLowerCase(),j=h.substring(h.indexOf("://")+3);if(".dae"===i){var k=this.loadCollada(b+"/"+j);return g.visual.geometry.scale&&(k.scale=new THREE.Vector3(g.visual.geometry.scale.x,g.visual.geometry.scale.y,g.visual.geometry.scale.z)),k}}}}},GZ3D.Scene.prototype.loadCollada=function(a){var b,c=new THREE.ColladaLoader;return c.load(a,function(a){b=a.scene,b.updateMatrix()}),b};