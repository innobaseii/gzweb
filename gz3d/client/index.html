<!DOCTYPE html>
<html lang="en">
  <head>
    <title>gz3d</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0">
    <link rel="stylesheet" href="style/jquery-mobile/jquery.mobile-1.4.0.min.css" />
    <script src="js/include/jquery-1.9.1.js"></script>
    <script src="js/include/jquery.mobile-1.4.0.min.js"></script>
    <script src="js/include/three.js"></script>
    <script src="js/include/OrbitControls.js"></script>
    <script src="js/include/TransformControls.js"></script>
    <script src="js/include/Detector.js"></script>
    <script src="js/include/stats.min.js"></script>
    <script src="js/include/eventemitter2.js"></script>
    <script src="js/include/roslib.js"></script>
    <script src="js/include/ColladaLoader.js"></script>
    <script src="js/include/CopyShader.js"></script>
    <script src="js/include/SSAOShader.js"></script>
    <script src="js/include/EffectComposer.js"></script>
    <script src="js/include/RenderPass.js"></script>
    <script src="js/include/MaskPass.js"></script>
    <script src="js/include/ShaderPass.js"></script>
    <script src="gz3d.js"></script>

    <style>
      #container {
        padding: 0;
        position : absolute;
        top: 43px;
        bottom: 50px;
        right: 0px;
        left: 0px;
      }
      th, td {
        white-space: nowrap;
      }
      @media (min-width:35em) {
        /* disable "dismiss" on wide viewports */
        .ui-panel-dismiss {
          display: none;
        }
      }
    </style>
  </head>

  <script id="heightmapVS" type="x-shader/x-vertex">
    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormal;

    void main( void ) {
      vUv = uv;
      vPosition = position;
      vNormal = normal;

      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  </script>

  <script id="heightmapFS" type="x-shader/x-fragment">

    uniform sampler2D texture0;
    uniform sampler2D texture1;
    uniform sampler2D texture2;

    uniform float repeat0;
    uniform float repeat1;
    uniform float repeat2;

    uniform float minHeight1;
    uniform float minHeight2;

    uniform float fadeDist1;
    uniform float fadeDist2;

    uniform vec3 ambient;
    uniform vec3 lightDiffuse;
    uniform vec3 lightDir;

    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormal;

    float blend(float distance, float fadeDist) {
      float alpha = distance / fadeDist;
      if (alpha < 0.0) {
        alpha = 0.0;
      }
      if (alpha > 1.0) {
        alpha = 1.0;
      }
      return alpha;
    }

    void main()
    {
      // Texture loading
      vec3 diffuse0 = texture2D( texture0, vUv*repeat0 ).rgb;
      vec3 diffuse1 = texture2D( texture1, vUv*repeat1 ).rgb;
      vec3 diffuse2 = texture2D( texture2, vUv*repeat2 ).rgb;

      // Get base texture
      vec3 fragcolor = diffuse0;

      // texture level 1
      fragcolor = mix(
        fragcolor,
        diffuse1,
        blend(vPosition.z - minHeight1, fadeDist1)
      );

      // texture level 2
      fragcolor = mix(
        fragcolor,
        diffuse2,
        blend(vPosition.z - (minHeight1 + minHeight2), fadeDist2)
      );

      vec3 lightDirNorm = normalize(lightDir);
      float intensity = max(dot(vNormal, lightDirNorm), 0.0);
      vec3 vLightFactor = ambient + lightDiffuse * intensity;
      gl_FragColor = vec4(fragcolor.rgb * vLightFactor, 1.0);
    }
  </script>

  <body>
    <div data-role="page" data-theme="b" data-content-theme="c">

      <!-- panel -->
      <div data-role="panel" id="leftPanel" data-display="overlay">
        <ul data-role="listview" data-theme="b">
          <li data-icon="delete"><a href="#" data-rel="close"></a></li>
          <li data-role="list-divider">Menu</li>
          <li data-role="list-divider"></li>
        </ul>
        <div data-role="collapsible" data-inset="false" data-iconpos="left" data-collapsed-icon="carat-r" data-expanded-icon="carat-d">
            <h3>Edit</h3>
            <ul data-role="listview">
              <li id='reset-world' data-icon="false"><a href="#">Reset World</a></li>
              <li id='reset-model' data-icon="false"><a href="#">Reset Model Poses</a></li>
            </ul>
        </div>
        <div data-role="collapsible" data-inset="false" data-iconpos="left" data-collapsed-icon="carat-r" data-expanded-icon="carat-d">
            <h3>View</h3>
            <ul data-role="listview">
              <!--<li id='view-effects' data-icon="false" data-iconpos="right"><a href="#">SSAO effect</a></li>-->
              <li id='view-collisions' data-icon="false" data-iconpos="right"><a href="#">Collisions</a></li>
            </ul>
        </div>
        <div data-role="collapsible" data-inset="false" data-iconpos="left" data-collapsed-icon="carat-r" data-expanded-icon="carat-d">
            <h3>Insert</h3>
            <ul data-role="listview">
              <li id="box" data-icon="false"><a href="#">Box</a></li>
              <li id="sphere" data-icon="false"><a href="#">Sphere</a></li>
              <li id="cylinder" data-icon="false"><a href="#">Cylinder</a></li>
            </ul>
        </div>
      </div><!-- panel -->

      <!-- header -->
      <div id="theHeader" data-role="header" data-position="fixed" style="height: 43px;">
        <a href="#leftPanel" class="ui-btn-left" data-icon="bars" data-iconpos="notext">Open panel</a>

        <h1></h1>

        <fieldset data-role="controlgroup" data-mini="true" data-type="horizontal" class="ui-btn-right">
          <input type="radio" name="radio-mini" id="view-mode" value="choice-1" checked="checked" />
          <label for="view-mode"><img src="style/images/arrow.png"></label>

          <input type="radio" name="radio-mini" id="translate-mode" value="choice-2"  />
          <label for="translate-mode"><img src="style/images/translate.png"></label>

          <input type="radio" name="radio-mini" id="rotate-mode" value="choice-3"  />
          <label for="rotate-mode"><img src="style/images/rotate.png"></label>
        </fieldset>

      </div><!-- header -->

      <!-- content -->
      <div data-role="content" id="container">
      </div><!-- content -->

      <!-- footer -->
      <div data-role="footer" data-position="fixed" data-tap-toggle="false" style="height: 50px;">
        <div class="ui-grid-b">
           <div class="ui-block-a">
             <a href="#" data-role="button" id="play"><span id="playText"><img src="style/images/play.png"></span></a>
           </div>
           <div class="ui-block-b">
             <table>
               <tr>
                 <td>Sim Time: </td>
               </tr>
               <tr>
                 <td id='sim-time-value'>00 00:00:00</td>
               </tr>
             </table>
           </div>
           <div class="ui-block-c">
             <table>
               <tr>
                 <td>Real Time: </td>
               </tr>
               <tr>
                 <td id='real-time-value'>00 00:00:00</td>
               </tr>
             </table>
           </div>
         </div>
      </div><!-- footer -->
    </div><!-- page -->

    <!-- WebGL -->
    <script>
      if (!Detector.webgl)
        Detector.addGetWebGLMessage();

      var container, stats;
      var scene;
      // Are these necessary?
      //var cross;
      //var visuals = {};

      // Container (canvas) dimensions
      window.containerHeight = window.innerHeight-(43+50+4); // give space for header and footer
      window.containerWidth = window.innerWidth;

      init();
      animate();

      function init()
      {
        scene = new GZ3D.Scene();
        gui = new GZ3D.Gui(scene);
        iface = new GZ3D.GZIface(scene, gui);

        container = document.getElementById( 'container' );
        container.appendChild(scene.getDomElement());

        // FPS indicator
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex = 100;
        container.appendChild( stats.domElement );

        window.addEventListener( 'resize', onWindowResize, false);
      }

      function onWindowResize()
      {
        //TODO: It doesn't resize well on horizontal (landscape) -> vertical (portrait)
        window.containerHeight = window.innerHeight-(43+50+4); // give space for header and footer
        window.containerWidth = window.innerWidth;
        scene.setWindowSize(window.containerWidth, window.containerHeight);
      }

      function animate()
      {
        requestAnimationFrame(animate);
        render();
      }

      function render()
      {
        scene.render();
        stats.update();
      }
    </script>

  </body>
</html>
